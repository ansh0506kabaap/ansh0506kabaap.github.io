<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Warmapper</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        button { background: #4a90e2; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; margin: 10px 0; cursor: pointer; }
        #log { background: #2c3e50; color: #27ae60; padding: 15px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: auto; font-size: 13px; }
        .info { margin-bottom: 10px; font-size: 14px; color: #333; }
    </style>
</head>
<body>

<div class="card">
    <h2>WiFi Warmapper</h2>
    <div class="info" id="status">Status: Disconnected</div>
    <div class="info" id="gps">GPS: Awaiting...</div>
    <button id="connectBtn">Connect ESP32</button>
    <button id="downloadBtn">Download CSV</button>
    <div id="log">Incoming data...</div>
</div>

<script>
    // FULL UUIDs from your Windows Screenshot
    const SERVICE_UUID = "0000ff01-0000-1000-8000-00805f9b34fb";
    const CHAR_UUID = "0000ff02-0000-1000-8000-00805f9b34fb";

    let capturedData = [];
    let currentPos = { lat: 0, lng: 0 };

    // GPS Watcher
    navigator.geolocation.watchPosition(p => {
        currentPos = { lat: p.coords.latitude, lng: p.coords.longitude };
        document.getElementById('gps').innerText = `GPS: ${currentPos.lat.toFixed(5)}, ${currentPos.lng.toFixed(5)}`;
    }, err => console.log(err), { enableHighAccuracy: true });

    document.getElementById('connectBtn').addEventListener('click', async () => {
        try {
            const status = document.getElementById('status');
            status.innerText = "Status: Searching...";
            
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'ESP32-WarMapper' }],
                optionalServices: [SERVICE_UUID]
            });

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            const char = await service.getCharacteristic(CHAR_UUID);

            await char.startNotifications();
            status.innerText = "Status: FULLY SYNCED";
            
            char.addEventListener('characteristicvaluechanged', (e) => {
                const val = new TextDecoder().decode(e.target.value);
                const log = document.getElementById('log');
                const entry = { time: new Date().toLocaleTimeString(), lat: currentPos.lat, lng: currentPos.lng, data: val };
                
                capturedData.push(entry);
                log.innerHTML = `<div>[${entry.time}] ${val}</div>` + log.innerHTML;
            });
        } catch (e) {
            document.getElementById('status').innerText = "Error: " + e.message;
        }
    });

    document.getElementById('downloadBtn').onclick = () => {
        let csv = "Time,Lat,Lng,WiFi_Data\n" + capturedData.map(r => `${r.time},${r.lat},${r.lng},${r.data}`).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'warmapper.csv'; a.click();
    };
</script>
</body>
</html>
